templates:
  osdcloud:
    PSCommand: ['Start-OSDCloud -Firmware -SkipAutopilot -SkipODT -ZTI -OSVersion "Windows 11" -OSBuild "23H2" -OSEdition "Pro" -OSLanguage "en-gb" -OSLicense "Retail"']

controls:
- SetTimer: ['winpe_start']

#################################################################################################
# Install Windows                                                                               #
#################################################################################################

#- MkDir: ['X:\OSDCloud']
#- MkDir: ['X:\OSDCloud\Autopilot']
#- MkDir: ['X:\OSDCloud\Autopilot\Profiles']

#- pull:
#  - ['AutopilotConfigurationFile.json', 'X:\OSDCloud\Autopilot\Profiles\AutopilotConfigurationFile.json']

- template:
  - 'osdcloud'

#################################################################################################
# Install bootloader                                                                            #
#################################################################################################

- PSCommand: ['& X:\Windows\System32\bcdboot.exe C:\Windows /c /v']

#################################################################################################
# Pre-install the December 2023 cumulative update (kb5033375)                                   #
#################################################################################################

- UpdateMSU:
  - ['https://catalog.sf.dl.delivery.mp.microsoft.com/filestreamingservice/files/e082275c-9281-429a-be97-ac6fef637e92/public/windows11.0-kb5033375-x64_516f4fb2bb560cddf08e9d744de8029f802dec21.msu', 'C:\glazier_cache\kb5033375.msu', '2b786924068c68797b12e5079942c028fa815a0dc5241f8fcf4e1920e9b9a80b']

#################################################################################################
# Handle the initial unattend configuration                                                     #
#################################################################################################

- pull:
  - ['initial/unattend.xml', 'C:\Windows\Panther\Invoke-OSDSpecialize.xml']
  - ['oobe/unattend.xml', 'C:\Windows\system32\sysprep\unattend.xml']

- Execute: [
  ['C:\Windows\System32\reg.exe load HKLM\TempSYSTEM C:\Windows\System32\Config\SYSTEM'],
  ['C:\Windows\System32\reg.exe add HKLM\TempSYSTEM\Setup /v UnattendFile /d C:\Windows\Panther\Invoke-OSDSpecialize.xml /f'],
  ['C:\Windows\System32\reg.exe unload HKLM\TempSYSTEM'],
]

#################################################################################################
# Copy files from WinPE to the host for later use                                               #
#################################################################################################

- PSCommand: ['mkdir C:\glazier_cache']

- CopyDir: ['X:\Python', 'C:\Python', true]
- CopyDir: ['X:\glazier', 'C:\glazier', true]
- CopyDir: ['X:\glazier-resources', 'C:\glazier-resources', true]
- pull:
  - ['autobuild.ps1', 'C:\windows\system32\autobuild.ps1']

- BuildInfoDump: []

- SetTimer: ['winpe_stop']

#################################################################################################
# Exit WinPE                                                                                    #
#################################################################################################
- ExitWinPE: []

#################################################################################################
# Enter Host                                                                                    #
#################################################################################################
- SetTimer: ['host_start']

- BuildInfoSave: []

# Launch Glazier with every subsequent reboot
- MultiRegAdd: [
  ['HKCU', 'Software\Microsoft\Windows NT\CurrentVersion\Winlogon', 'Shell', 'powershell.exe -NoProfile -WindowStyle Maximized -NoExit -NoLogo -ExecutionPolicy Bypass -Command & C:\windows\system32\autobuild.ps1', 'REG_SZ'],
  ['HKCU', 'Software\Microsoft\Windows\CurrentVersion\Policies\Explorer', 'NoLogoff', 1, 'REG_DWORD'],
  ['HKCU', 'Software\Microsoft\Windows\CurrentVersion\Policies\System', 'DisableChangePassword', 1, 'REG_DWORD'],
  ['HKCU', 'Software\Microsoft\Windows\CurrentVersion\Policies\System', 'DisableLockWorkstation', 1, 'REG_DWORD'],
]

#################################################################################################
# Install Windows Updates                                                                       #
#################################################################################################

- MultiPSCommand:
  - ['Set-ExecutionPolicy Unrestricted -Force']
  - ['Set-PSRepository -Name PSGallery -InstallationPolicy Trusted']
  - ['Install-Module PSWindowsUpdate -Confirm:$false']
  - ['Start-Service -name wuauserv']

- Sleep: [60, 'Waiting for Windows Update to initialise...']

- MultiPSCommand:
  - ['Get-WindowsUpdate -MicrosoftUpdate -Verbose']
  - ['Install-WindowsUpdate -AcceptAll -Install -MicrosoftUpdate -AutoReboot -Verbose']

- Sleep: [15, 'Waiting for Windows Update reboot if required...']

- MultiPSCommand:
  - ['Set-PSRepository -Name PSGallery -InstallationPolicy Untrusted']
  - ['Set-ExecutionPolicy Restricted -Force']

#################################################################################################
# Install Software                                                                              #
#################################################################################################

- MkDir: ['C:\glazier_cache\install_temp']
- MkDir: ['C:\glazier_cache\install_temp\odt']

- pull:
  - ['Office365/officedeploymenttool_15128-20224.exe', 'C:\glazier_cache\install_temp\odt_installer.exe']
  - ['Office365/config.xml', 'C:\glazier_cache\install_temp\odt\custom-config.xml']

- PSCommand: ['& C:\glazier_cache\install_temp\odt_installer.exe /extract:C:\glazier_cache\install_temp\odt /quiet /norestart']

- PSCommand: ['& C:\glazier_cache\install_temp\odt\setup.exe /configure C:\glazier_cache\install_temp\odt\custom-config.xml']

#################################################################################################
# Configure AutoPilot                                                                           #
#################################################################################################

- pull:
  - ['AutopilotConfigurationFile.json', 'C:\Windows\Provisioning\Autopilot\AutopilotConfigurationFile.json']

#################################################################################################
# Complete the install                                                                          #
#################################################################################################

- MultiPSCommand: [
  ['& C:\Windows\System32\reg.exe delete HKLM\SYSTEM\Setup /v UnattendFile /f'],
]

- Reboot: [10, 'Rebooting before OOBE']

- MultiRegAdd: [
  ['HKLM', 'Software\Microsoft\Windows NT\CurrentVersion\Winlogon', 'AutoAdminLogon', '0', 'REG_SZ']
]

- MultiPSCommand: [
  ['& C:\Windows\System32\reg.exe add "HKLM\Software\Microsoft\Provisioning" /v FirstRunComplete /t REG_DWORD /d 0 /f'],
  ['& C:\Windows\System32\Sysprep\sysprep.exe /oobe /quiet /reboot /unattend:C:\Windows\system32\sysprep\unattend.xml'],
]

- Reboot: [10, 'Rebooting into OOBE']